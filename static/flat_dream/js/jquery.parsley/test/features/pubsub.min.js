define(function(){return function(){describe("PubSub",function(){it("listen() without context",function(a){$.listen("foo",function(b){expect(b).to.be("bar");a()});$.emit("foo","bar")});it("listen() with context",function(a){var b={foo:function(c){return"foo"+c}};$.listen("foo",b,function(c){expect(this.foo(c)).to.be("foobar");a()});$.emit("foo","bar")});it("listenTo() ParsleyField",function(b){$("body").append('<input type="text" id="element" />');$("body").append('<input type="text" id="element2" />');var a=$("#element").psly();$.listenTo(a,"foo",function(c){expect(c.__id__).to.be(a.__id__);b()});$.emit("foo","bar");$.emit("foo",$("#element2").psly());$.emit("foo",a)});it("listenTo() ParsleyForm will listen to Form",function(a){$("body").append('<form id="element" data-parsley-trigger="change"><input id="field1" type="text" data-parsley-required="true" /><div id="field2"></div><textarea id="field3" data-parsley-notblank="true"></textarea></form>');$.listenTo($("#element").psly(),"foo",function(b){expect($("#element").psly().__id__===b.__id__);a()});$.emit("foo",$("#element").psly())});it("listenTo() Form will listen to its fields too",function(a){$("body").append('<form id="element" data-parsley-trigger="change"><input id="field1" type="text" data-parsley-required="true" /><div id="field2"></div><textarea id="field3" data-parsley-notblank="true"></textarea></form>');$.listenTo($("#element").psly(),"foo",function(b){a()});$.emit("foo",$("#field1").psly())});it("unsubscribeTo()",function(){$("body").append('<input type="text" id="element" />');$.listen("foo",$.noop);$.listenTo($("#element").psly(),"foo",$.noop);expect($.subscribed()).to.have.key("foo");expect($.subscribed().foo.length).to.be(2);$.unsubscribeTo($("#element").psly(),"foo");expect($.subscribed().foo.length).to.be(1)});it("unsubscribe()",function(){$.listen("foo",$.noop);expect($.subscribed()).to.have.key("foo");expect($.subscribed().foo.length).to.be(1);$.unsubscribe("foo",$.noop);expect($.subscribed().foo.length).to.be(0)});afterEach(function(){if($("#element").length){$("#element").remove()}if($("#element2").length){$("#element2").remove()}$.unsubscribeAll("foo")})})}});